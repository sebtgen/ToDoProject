import { ChangeDetectionStrategy, Component, EventEmitter, Injector, Input, Output, ViewChild, } from '@angular/core';
import { CommonModule } from '@angular/common';
import { DynamicViewModule, isComponent, isTemplateRef } from '@ngneat/overview';
import { ENTER_ANIMATION_DURATION, EXIT_ANIMATION_DURATION, HOT_TOAST_DEPTH_SCALE, } from '../../constants';
import { HotToastRef } from '../../hot-toast-ref';
import { animate } from '../../utils';
import { IndicatorComponent } from '../indicator/indicator.component';
import { AnimatedIconComponent } from '../animated-icon/animated-icon.component';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "@ngneat/overview";
export class HotToastComponent {
    get toastsAfter() {
        return this._toastsAfter;
    }
    set toastsAfter(value) {
        this._toastsAfter = value;
        if (this.defaultConfig?.visibleToasts > 0) {
            if (this.toast.autoClose) {
                // if (value >= this.defaultConfig?.visibleToasts) {
                //   this.close();
                // }
            }
            else {
                if (value >= this.defaultConfig?.visibleToasts) {
                    this.softClose();
                }
                else if (this.softClosed) {
                    this.softOpen();
                }
            }
        }
    }
    constructor(injector, renderer, ngZone) {
        this.injector = injector;
        this.renderer = renderer;
        this.ngZone = ngZone;
        this.offset = 0;
        this._toastsAfter = 0;
        this.isShowingAllToasts = false;
        this.height = new EventEmitter();
        this.beforeClosed = new EventEmitter();
        this.afterClosed = new EventEmitter();
        this.showAllToasts = new EventEmitter();
        this.isManualClose = false;
        this.unlisteners = [];
        this.softClosed = false;
    }
    get toastBarBaseHeight() {
        return this.toastBarBase.nativeElement.offsetHeight;
    }
    get scale() {
        return this.defaultConfig.stacking !== 'vertical' && !this.isShowingAllToasts
            ? this.toastsAfter * -HOT_TOAST_DEPTH_SCALE + 1
            : 1;
    }
    get translateY() {
        return this.offset * (this.top ? 1 : -1) + 'px';
    }
    get exitAnimationDelay() {
        return this.toast.duration + 'ms';
    }
    get top() {
        return this.toast.position.includes('top');
    }
    get containerPositionStyle() {
        const verticalStyle = this.top ? { top: 0 } : { bottom: 0 };
        const transform = `translateY(var(--hot-toast-translate-y)) scale(var(--hot-toast-scale))`;
        const horizontalStyle = this.toast.position.includes('left')
            ? {
                left: 0,
            }
            : this.toast.position.includes('right')
                ? {
                    right: 0,
                }
                : {
                    left: 0,
                    right: 0,
                    justifyContent: 'center',
                };
        return {
            transform,
            ...verticalStyle,
            ...horizontalStyle,
        };
    }
    get toastBarBaseStyles() {
        const enterAnimation = `hotToastEnterAnimation${this.top ? 'Negative' : 'Positive'} ${ENTER_ANIMATION_DURATION}ms cubic-bezier(0.21, 1.02, 0.73, 1) forwards`;
        const exitAnimation = `hotToastExitAnimation${this.top ? 'Negative' : 'Positive'} ${EXIT_ANIMATION_DURATION}ms forwards cubic-bezier(0.06, 0.71, 0.55, 1) var(--hot-toast-exit-animation-delay) var(--hot-toast-exit-animation-state)`;
        const animation = this.toast.autoClose ? `${enterAnimation}, ${exitAnimation}` : enterAnimation;
        return { ...this.toast.style, animation };
    }
    get isIconString() {
        return typeof this.toast.icon === 'string';
    }
    ngOnChanges(changes) {
        if (changes.toast && !changes.toast.firstChange && changes.toast.currentValue?.message) {
            requestAnimationFrame(() => {
                this.height.emit(this.toastBarBase.nativeElement.offsetHeight);
            });
        }
    }
    ngOnInit() {
        if (isTemplateRef(this.toast.message)) {
            this.context = { $implicit: this.toastRef };
        }
        if (isComponent(this.toast.message)) {
            this.toastComponentInjector = Injector.create({
                providers: [
                    {
                        provide: HotToastRef,
                        useValue: this.toastRef,
                    },
                ],
                parent: this.toast.injector || this.injector,
            });
        }
    }
    ngAfterViewInit() {
        const nativeElement = this.toastBarBase.nativeElement;
        // Caretaker note: accessing `offsetHeight` triggers the whole layout update.
        // Macro tasks (like `setTimeout`) might be executed within the current rendering frame and cause a frame drop.
        requestAnimationFrame(() => {
            this.height.emit(nativeElement.offsetHeight);
        });
        // Caretaker note: `animationstart` and `animationend` events are event tasks that trigger change detection.
        // We'd want to trigger the change detection only if it's an exit animation.
        this.ngZone.runOutsideAngular(() => {
            this.unlisteners.push(
            // Caretaker note: we have to remove these event listeners at the end (even if the element is removed from DOM).
            // zone.js stores its `ZoneTask`s within the `nativeElement[Zone.__symbol__('animationstart') + 'false']` property
            // with callback that capture `this`.
            this.renderer.listen(nativeElement, 'animationstart', (event) => {
                if (this.isExitAnimation(event)) {
                    this.ngZone.run(() => this.beforeClosed.emit());
                }
            }), this.renderer.listen(nativeElement, 'animationend', (event) => {
                if (this.isExitAnimation(event)) {
                    this.ngZone.run(() => this.afterClosed.emit({ dismissedByAction: this.isManualClose, id: this.toast.id }));
                }
            }));
        });
        this.setToastAttributes();
    }
    softClose() {
        const exitAnimation = `hotToastExitSoftAnimation${this.top ? 'Negative' : 'Positive'} ${EXIT_ANIMATION_DURATION}ms forwards cubic-bezier(0.06, 0.71, 0.55, 1)`;
        const nativeElement = this.toastBarBase.nativeElement;
        animate(nativeElement, exitAnimation);
        this.softClosed = true;
    }
    softOpen() {
        const softEnterAnimation = `hotToastEnterSoftAnimation${top ? 'Negative' : 'Positive'} ${ENTER_ANIMATION_DURATION}ms cubic-bezier(0.21, 1.02, 0.73, 1) forwards`;
        const nativeElement = this.toastBarBase.nativeElement;
        animate(nativeElement, softEnterAnimation);
        this.softClosed = false;
    }
    close() {
        this.isManualClose = true;
        const exitAnimation = `hotToastExitAnimation${this.top ? 'Negative' : 'Positive'} ${EXIT_ANIMATION_DURATION}ms forwards cubic-bezier(0.06, 0.71, 0.55, 1)`;
        const nativeElement = this.toastBarBase.nativeElement;
        animate(nativeElement, exitAnimation);
    }
    handleMouseEnter() {
        this.showAllToasts.emit(true);
    }
    handleMouseLeave() {
        this.showAllToasts.emit(false);
    }
    ngOnDestroy() {
        this.close();
        while (this.unlisteners.length) {
            this.unlisteners.pop()();
        }
    }
    isExitAnimation(ev) {
        return ev.animationName.includes('hotToastExitAnimation');
    }
    setToastAttributes() {
        const toastAttributes = this.toast.attributes;
        for (const [key, value] of Object.entries(toastAttributes)) {
            this.renderer.setAttribute(this.toastBarBase.nativeElement, key, value);
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.1", ngImport: i0, type: HotToastComponent, deps: [{ token: i0.Injector }, { token: i0.Renderer2 }, { token: i0.NgZone }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.2.1", type: HotToastComponent, isStandalone: true, selector: "hot-toast", inputs: { toast: "toast", offset: "offset", defaultConfig: "defaultConfig", toastRef: "toastRef", toastsAfter: "toastsAfter", isShowingAllToasts: "isShowingAllToasts" }, outputs: { height: "height", beforeClosed: "beforeClosed", afterClosed: "afterClosed", showAllToasts: "showAllToasts" }, viewQueries: [{ propertyName: "toastBarBase", first: true, predicate: ["hotToastBarBase"], descendants: true }], usesOnChanges: true, ngImport: i0, template: "<div\n  class=\"hot-toast-bar-base-container\"\n  [ngStyle]=\"containerPositionStyle\"\n  [ngClass]=\"'hot-toast-theme-' + toast.theme\"\n  [style.--hot-toast-scale]=\"scale\"\n  [style.--hot-toast-translate-y]=\"translateY\"\n>\n  <div\n    class=\"hot-toast-bar-base-wrapper\"\n    (mouseenter)=\"handleMouseEnter()\"\n    (mouseleave)=\"handleMouseLeave()\"\n  >\n    <div\n      class=\"hot-toast-bar-base\"\n      #hotToastBarBase\n      [ngStyle]=\"toastBarBaseStyles\"\n      [ngClass]=\"toast.className\"\n      [style.--hot-toast-animation-state]=\"isManualClose ? 'running' : 'paused'\"\n      [style.--hot-toast-exit-animation-state]=\"isShowingAllToasts ? 'paused' : 'running'\"\n      [style.--hot-toast-exit-animation-delay]=\"exitAnimationDelay\"\n      [attr.aria-live]=\"toast.ariaLive\"\n      [attr.role]=\"toast.role\"\n    >\n      <div class=\"hot-toast-icon\" aria-hidden=\"true\">\n        <ng-container *ngIf=\"toast.icon !== undefined; else indicator\">\n          <ng-container *ngIf=\"isIconString; else iconTemplateOrComponent\">\n            <hot-toast-animated-icon [iconTheme]=\"toast.iconTheme\">{{ toast.icon }}</hot-toast-animated-icon>\n          </ng-container>\n          <ng-template #iconTemplateOrComponent>\n            <div>\n              <ng-container *dynamicView=\"toast.icon\"></ng-container>\n            </div>\n          </ng-template>\n        </ng-container>\n\n        <ng-template #indicator>\n          <hot-toast-indicator [theme]=\"toast.iconTheme\" [type]=\"toast.type\"></hot-toast-indicator>\n        </ng-template>\n      </div>\n\n      <div class=\"hot-toast-message\">\n        <div>\n          <ng-container *dynamicView=\"toast.message; context: context; injector: toastComponentInjector\"></ng-container>\n        </div>\n      </div>\n\n      <button\n        *ngIf=\"toast.dismissible\"\n        (click)=\"close()\"\n        type=\"button\"\n        class=\"hot-toast-close-btn\"\n        aria-label=\"Close\"\n        [ngStyle]=\"toast.closeStyle\"\n      ></button>\n    </div>\n  </div>\n</div>\n", dependencies: [{ kind: "ngmodule", type: CommonModule }, { kind: "directive", type: i1.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { kind: "directive", type: i1.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i1.NgStyle, selector: "[ngStyle]", inputs: ["ngStyle"] }, { kind: "ngmodule", type: DynamicViewModule }, { kind: "directive", type: i2.DynamicViewDirective, selector: "[dynamicView]", inputs: ["dynamicView", "dynamicViewInjector", "dynamicViewContext", "dynamicViewInputs"] }, { kind: "component", type: IndicatorComponent, selector: "hot-toast-indicator", inputs: ["theme", "type"] }, { kind: "component", type: AnimatedIconComponent, selector: "hot-toast-animated-icon", inputs: ["iconTheme"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush, preserveWhitespaces: true }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.1", ngImport: i0, type: HotToastComponent, decorators: [{
            type: Component,
            args: [{ selector: 'hot-toast', changeDetection: ChangeDetectionStrategy.OnPush, standalone: true, imports: [CommonModule, DynamicViewModule, IndicatorComponent, AnimatedIconComponent], template: "<div\n  class=\"hot-toast-bar-base-container\"\n  [ngStyle]=\"containerPositionStyle\"\n  [ngClass]=\"'hot-toast-theme-' + toast.theme\"\n  [style.--hot-toast-scale]=\"scale\"\n  [style.--hot-toast-translate-y]=\"translateY\"\n>\n  <div\n    class=\"hot-toast-bar-base-wrapper\"\n    (mouseenter)=\"handleMouseEnter()\"\n    (mouseleave)=\"handleMouseLeave()\"\n  >\n    <div\n      class=\"hot-toast-bar-base\"\n      #hotToastBarBase\n      [ngStyle]=\"toastBarBaseStyles\"\n      [ngClass]=\"toast.className\"\n      [style.--hot-toast-animation-state]=\"isManualClose ? 'running' : 'paused'\"\n      [style.--hot-toast-exit-animation-state]=\"isShowingAllToasts ? 'paused' : 'running'\"\n      [style.--hot-toast-exit-animation-delay]=\"exitAnimationDelay\"\n      [attr.aria-live]=\"toast.ariaLive\"\n      [attr.role]=\"toast.role\"\n    >\n      <div class=\"hot-toast-icon\" aria-hidden=\"true\">\n        <ng-container *ngIf=\"toast.icon !== undefined; else indicator\">\n          <ng-container *ngIf=\"isIconString; else iconTemplateOrComponent\">\n            <hot-toast-animated-icon [iconTheme]=\"toast.iconTheme\">{{ toast.icon }}</hot-toast-animated-icon>\n          </ng-container>\n          <ng-template #iconTemplateOrComponent>\n            <div>\n              <ng-container *dynamicView=\"toast.icon\"></ng-container>\n            </div>\n          </ng-template>\n        </ng-container>\n\n        <ng-template #indicator>\n          <hot-toast-indicator [theme]=\"toast.iconTheme\" [type]=\"toast.type\"></hot-toast-indicator>\n        </ng-template>\n      </div>\n\n      <div class=\"hot-toast-message\">\n        <div>\n          <ng-container *dynamicView=\"toast.message; context: context; injector: toastComponentInjector\"></ng-container>\n        </div>\n      </div>\n\n      <button\n        *ngIf=\"toast.dismissible\"\n        (click)=\"close()\"\n        type=\"button\"\n        class=\"hot-toast-close-btn\"\n        aria-label=\"Close\"\n        [ngStyle]=\"toast.closeStyle\"\n      ></button>\n    </div>\n  </div>\n</div>\n" }]
        }], ctorParameters: function () { return [{ type: i0.Injector }, { type: i0.Renderer2 }, { type: i0.NgZone }]; }, propDecorators: { toast: [{
                type: Input
            }], offset: [{
                type: Input
            }], defaultConfig: [{
                type: Input
            }], toastRef: [{
                type: Input
            }], toastsAfter: [{
                type: Input
            }], isShowingAllToasts: [{
                type: Input
            }], height: [{
                type: Output
            }], beforeClosed: [{
                type: Output
            }], afterClosed: [{
                type: Output
            }], showAllToasts: [{
                type: Output
            }], toastBarBase: [{
                type: ViewChild,
                args: ['hotToastBarBase']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG90LXRvYXN0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25nbmVhdC9ob3QtdG9hc3Qvc3JjL2xpYi9jb21wb25lbnRzL2hvdC10b2FzdC9ob3QtdG9hc3QuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmduZWF0L2hvdC10b2FzdC9zcmMvbGliL2NvbXBvbmVudHMvaG90LXRvYXN0L2hvdC10b2FzdC5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsdUJBQXVCLEVBQ3ZCLFNBQVMsRUFFVCxZQUFZLEVBQ1osUUFBUSxFQUNSLEtBQUssRUFLTCxNQUFNLEVBR04sU0FBUyxHQUNWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWpGLE9BQU8sRUFDTCx3QkFBd0IsRUFDeEIsdUJBQXVCLEVBQ3ZCLHFCQUFxQixHQUN0QixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUVsRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3RFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDBDQUEwQyxDQUFDOzs7O0FBU2pGLE1BQU0sT0FBTyxpQkFBaUI7SUFNNUIsSUFBSSxXQUFXO1FBQ2IsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDO0lBQzNCLENBQUM7SUFDRCxJQUNJLFdBQVcsQ0FBQyxLQUFLO1FBQ25CLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFD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LEVBQUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ3pFO0lBQ0gsQ0FBQzs4R0E1TlUsaUJBQWlCO2tHQUFqQixpQkFBaUIsOGVDdEM5Qix1aEVBeURBLDJDRHJCWSxZQUFZLHFUQUFFLGlCQUFpQiwyTUFBRSxrQkFBa0IsMkZBQUUscUJBQXFCOzsyRkFFekUsaUJBQWlCO2tCQVA3QixTQUFTOytCQUNFLFdBQVcsbUJBRUosdUJBQXVCLENBQUMsTUFBTSxjQUNuQyxJQUFJLFdBQ1AsQ0FBQyxZQUFZLEVBQUUsaUJBQWlCLEVBQUUsa0JBQWtCLEVBQUUscUJBQXFCLENBQUM7NElBRzVFLEtBQUs7c0JBQWIsS0FBSztnQkFDRyxNQUFNO3NCQUFkLEtBQUs7Z0JBQ0csYUFBYTtzQkFBckIsS0FBSztnQkFDRyxRQUFRO3NCQUFoQixLQUFLO2dCQU1GLFdBQVc7c0JBRGQsS0FBSztnQkFpQkcsa0JBQWtCO3NCQUExQixLQUFLO2dCQUVJLE1BQU07c0JBQWYsTUFBTTtnQkFDRyxZQUFZO3NCQUFyQixNQUFNO2dCQUNHLFdBQVc7c0JBQXBCLE1BQU07Z0JBQ0csYUFBYTtzQkFBdEIsTUFBTTtnQkFFK0IsWUFBWTtzQkFBakQsU0FBUzt1QkFBQyxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlclZpZXdJbml0LFxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIEluamVjdG9yLFxuICBJbnB1dCxcbiAgTmdab25lLFxuICBPbkNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBPdXRwdXQsXG4gIFJlbmRlcmVyMixcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgVmlld0NoaWxkLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbW1vbk1vZHVsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBEeW5hbWljVmlld01vZHVsZSwgaXNDb21wb25lbnQsIGlzVGVtcGxhdGVSZWYgfSBmcm9tICdAbmduZWF0L292ZXJ2aWV3JztcblxuaW1wb3J0IHtcbiAgRU5URVJfQU5JTUFUSU9OX0RVUkFUSU9OLFxuICBFWElUX0FOSU1BVElPTl9EVVJBVElPTixcbiAgSE9UX1RPQVNUX0RFUFRIX1NDQUxFLFxufSBmcm9tICcuLi8uLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgSG90VG9hc3RSZWYgfSBmcm9tICcuLi8uLi9ob3QtdG9hc3QtcmVmJztcbmltcG9ydCB7IENyZWF0ZUhvdFRvYXN0UmVmLCBIb3RUb2FzdENsb3NlLCBUb2FzdCwgVG9hc3RDb25maWcgfSBmcm9tICcuLi8uLi9ob3QtdG9hc3QubW9kZWwnO1xuaW1wb3J0IHsgYW5pbWF0ZSB9IGZyb20gJy4uLy4uL3V0aWxzJztcbmltcG9ydCB7IEluZGljYXRvckNvbXBvbmVudCB9IGZyb20gJy4uL2luZGljYXRvci9pbmRpY2F0b3IuY29tcG9uZW50JztcbmltcG9ydCB7IEFuaW1hdGVkSWNvbkNvbXBvbmVudCB9IGZyb20gJy4uL2FuaW1hdGVkLWljb24vYW5pbWF0ZWQtaWNvbi5jb21wb25lbnQnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdob3QtdG9hc3QnLFxuICB0ZW1wbGF0ZVVybDogJ2hvdC10b2FzdC5jb21wb25lbnQuaHRtbCcsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuICBzdGFuZGFsb25lOiB0cnVlLFxuICBpbXBvcnRzOiBbQ29tbW9uTW9kdWxlLCBEeW5hbWljVmlld01vZHVsZSwgSW5kaWNhdG9yQ29tcG9uZW50LCBBbmltYXRlZEljb25Db21wb25lbnRdLFxufSlcbmV4cG9ydCBjbGFzcyBIb3RUb2FzdENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95LCBPbkNoYW5nZXMge1xuICBASW5wdXQoKSB0b2FzdDogVG9hc3Q8dW5rbm93bj47XG4gIEBJbnB1dCgpIG9mZnNldCA9IDA7XG4gIEBJbnB1dCgpIGRlZmF1bHRDb25maWc6IFRvYXN0Q29uZmlnO1xuICBASW5wdXQoKSB0b2FzdFJlZjogQ3JlYXRlSG90VG9hc3RSZWY8dW5rbm93bj47XG4gIHByaXZhdGUgX3RvYXN0c0FmdGVyID0gMDtcbiAgZ2V0IHRvYXN0c0FmdGVyKCkge1xuICAgIHJldHVybiB0aGlzLl90b2FzdHNBZnRlcjtcbiAgfVxuICBASW5wdXQoKVxuICBzZXQgdG9hc3RzQWZ0ZXIodmFsdWUpIHtcbiAgICB0aGlzLl90b2FzdHNBZnRlciA9IHZhbHVlO1xuICAgIGlmICh0aGlzLmRlZmF1bHRDb25maWc/LnZpc2libGVUb2FzdHMgPiAwKSB7XG4gICAgICBpZiAodGhpcy50b2FzdC5hdXRvQ2xvc2UpIHtcbiAgICAgICAgLy8gaWYgKHZhbHVlID49IHRoaXMuZGVmYXVsdENvbmZpZz8udmlzaWJsZVRvYXN0cykge1xuICAgICAgICAvLyAgIHRoaXMuY2xvc2UoKTtcbiAgICAgICAgLy8gfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHZhbHVlID49IHRoaXMuZGVmYXVsdENvbmZpZz8udmlzaWJsZVRvYXN0cykge1xuICAgICAgICAgIHRoaXMuc29mdENsb3NlKCk7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5zb2Z0Q2xvc2VkKSB7XG4gICAgICAgICAgdGhpcy5zb2Z0T3BlbigpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG4gIEBJbnB1dCgpIGlzU2hvd2luZ0FsbFRvYXN0cyA9IGZhbHNlO1xuXG4gIEBPdXRwdXQoKSBoZWlnaHQgPSBuZXcgRXZlbnRFbWl0dGVyPG51bWJlcj4oKTtcbiAgQE91dHB1dCgpIGJlZm9yZUNsb3NlZCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpIGFmdGVyQ2xvc2VkID0gbmV3IEV2ZW50RW1pdHRlcjxIb3RUb2FzdENsb3NlPigpO1xuICBAT3V0cHV0KCkgc2hvd0FsbFRvYXN0cyA9IG5ldyBFdmVudEVtaXR0ZXI8Ym9vbGVhbj4oKTtcblxuICBAVmlld0NoaWxkKCdob3RUb2FzdEJhckJhc2UnKSBwcml2YXRlIHRvYXN0QmFyQmFzZTogRWxlbWVudFJlZjxIVE1MRWxlbWVudD47XG5cbiAgaXNNYW51YWxDbG9zZSA9IGZhbHNlO1xuICBjb250ZXh0OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICB0b2FzdENvbXBvbmVudEluamVjdG9yOiBJbmplY3RvcjtcblxuICBwcml2YXRlIHVubGlzdGVuZXJzOiBWb2lkRnVuY3Rpb25bXSA9IFtdO1xuICBwcml2YXRlIHNvZnRDbG9zZWQgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLCBwcml2YXRlIG5nWm9uZTogTmdab25lKSB7fVxuXG4gIGdldCB0b2FzdEJhckJhc2VIZWlnaHQoKSB7XG4gICAgcmV0dXJuIHRoaXMudG9hc3RCYXJCYXNlLm5hdGl2ZUVsZW1lbnQub2Zmc2V0SGVpZ2h0O1xuICB9XG5cbiAgZ2V0IHNjYWxlKCkge1xuICAgIHJldHVybiB0aGlzLmRlZmF1bHRDb25maWcuc3RhY2tpbmcgIT09ICd2ZXJ0aWNhbCcgJiYgIXRoaXMuaXNTaG93aW5nQWxsVG9hc3RzXG4gICAgICA/IHRoaXMudG9hc3RzQWZ0ZXIgKiAtSE9UX1RPQVNUX0RFUFRIX1NDQUxFICsgMVxuICAgICAgOiAxO1xuICB9XG5cbiAgZ2V0IHRyYW5zbGF0ZVkoKSB7XG4gICAgcmV0dXJuIHRoaXMub2Zmc2V0ICogKHRoaXMudG9wID8gMSA6IC0xKSArICdweCc7XG4gIH1cblxuICBnZXQgZXhpdEFuaW1hdGlvbkRlbGF5KCkge1xuICAgIHJldHVybiB0aGlzLnRvYXN0LmR1cmF0aW9uICsgJ21zJztcbiAgfVxuXG4gIGdldCB0b3AoKSB7XG4gICAgcmV0dXJuIHRoaXMudG9hc3QucG9zaXRpb24uaW5jbHVkZXMoJ3RvcCcpO1xuICB9XG5cbiAgZ2V0IGNvbnRhaW5lclBvc2l0aW9uU3R5bGUoKSB7XG4gICAgY29uc3QgdmVydGljYWxTdHlsZSA9IHRoaXMudG9wID8geyB0b3A6IDAgfSA6IHsgYm90dG9tOiAwIH07XG4gICAgY29uc3QgdHJhbnNmb3JtID0gYHRyYW5zbGF0ZVkodmFyKC0taG90LXRvYXN0LXRyYW5zbGF0ZS15KSkgc2NhbGUodmFyKC0taG90LXRvYXN0LXNjYWxlKSlgO1xuXG4gICAgY29uc3QgaG9yaXpvbnRhbFN0eWxlID0gdGhpcy50b2FzdC5wb3NpdGlvbi5pbmNsdWRlcygnbGVmdCcpXG4gICAgICA/IHtcbiAgICAgICAgICBsZWZ0OiAwLFxuICAgICAgICB9XG4gICAgICA6IHRoaXMudG9hc3QucG9zaXRpb24uaW5jbHVkZXMoJ3JpZ2h0JylcbiAgICAgID8ge1xuICAgICAgICAgIHJpZ2h0OiAwLFxuICAgICAgICB9XG4gICAgICA6IHtcbiAgICAgICAgICBsZWZ0OiAwLFxuICAgICAgICAgIHJpZ2h0OiAwLFxuICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAnY2VudGVyJyxcbiAgICAgICAgfTtcbiAgICByZXR1cm4ge1xuICAgICAgdHJhbnNmb3JtLFxuICAgICAgLi4udmVydGljYWxTdHlsZSxcbiAgICAgIC4uLmhvcml6b250YWxTdHlsZSxcbiAgICB9O1xuICB9XG5cbiAgZ2V0IHRvYXN0QmFyQmFzZVN0eWxlcygpIHtcbiAgICBjb25zdCBlbnRlckFuaW1hdGlvbiA9IGBob3RUb2FzdEVudGVyQW5pbWF0aW9uJHtcbiAgICAgIHRoaXMudG9wID8gJ05lZ2F0aXZlJyA6ICdQb3NpdGl2ZSdcbiAgICB9ICR7RU5URVJfQU5JTUFUSU9OX0RVUkFUSU9OfW1zIGN1YmljLWJlemllcigwLjIxLCAxLjAyLCAwLjczLCAxKSBmb3J3YXJkc2A7XG5cbiAgICBjb25zdCBleGl0QW5pbWF0aW9uID0gYGhvdFRvYXN0RXhpdEFuaW1hdGlvbiR7XG4gICAgICB0aGlzLnRvcCA/ICdOZWdhdGl2ZScgOiAnUG9zaXRpdmUnXG4gICAgfSAke0VYSVRfQU5JTUFUSU9OX0RVUkFUSU9OfW1zIGZvcndhcmRzIGN1YmljLWJlemllcigwLjA2LCAwLjcxLCAwLjU1LCAxKSB2YXIoLS1ob3QtdG9hc3QtZXhpdC1hbmltYXRpb24tZGVsYXkpIHZhcigtLWhvdC10b2FzdC1leGl0LWFuaW1hdGlvbi1zdGF0ZSlgO1xuXG4gICAgY29uc3QgYW5pbWF0aW9uID0gdGhpcy50b2FzdC5hdXRvQ2xvc2UgPyBgJHtlbnRlckFuaW1hdGlvbn0sICR7ZXhpdEFuaW1hdGlvbn1gIDogZW50ZXJBbmltYXRpb247XG5cbiAgICByZXR1cm4geyAuLi50aGlzLnRvYXN0LnN0eWxlLCBhbmltYXRpb24gfTtcbiAgfVxuXG4gIGdldCBpc0ljb25TdHJpbmcoKSB7XG4gICAgcmV0dXJuIHR5cGVvZiB0aGlzLnRvYXN0Lmljb24gPT09ICdzdHJpbmcnO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xuICAgIGlmIChjaGFuZ2VzLnRvYXN0ICYmICFjaGFuZ2VzLnRvYXN0LmZpcnN0Q2hhbmdlICYmIGNoYW5nZXMudG9hc3QuY3VycmVudFZhbHVlPy5tZXNzYWdlKSB7XG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICB0aGlzLmhlaWdodC5lbWl0KHRoaXMudG9hc3RCYXJCYXNlLm5hdGl2ZUVsZW1lbnQub2Zmc2V0SGVpZ2h0KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmIChpc1RlbXBsYXRlUmVmKHRoaXMudG9hc3QubWVzc2FnZSkpIHtcbiAgICAgIHRoaXMuY29udGV4dCA9IHsgJGltcGxpY2l0OiB0aGlzLnRvYXN0UmVmIH07XG4gICAgfVxuICAgIGlmIChpc0NvbXBvbmVudCh0aGlzLnRvYXN0Lm1lc3NhZ2UpKSB7XG4gICAgICB0aGlzLnRvYXN0Q29tcG9uZW50SW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBwcm92aWRlOiBIb3RUb2FzdFJlZixcbiAgICAgICAgICAgIHVzZVZhbHVlOiB0aGlzLnRvYXN0UmVmLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICAgIHBhcmVudDogdGhpcy50b2FzdC5pbmplY3RvciB8fCB0aGlzLmluamVjdG9yLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIGNvbnN0IG5hdGl2ZUVsZW1lbnQgPSB0aGlzLnRvYXN0QmFyQmFzZS5uYXRpdmVFbGVtZW50O1xuICAgIC8vIENhcmV0YWtlciBub3RlOiBhY2Nlc3NpbmcgYG9mZnNldEhlaWdodGAgdHJpZ2dlcnMgdGhlIHdob2xlIGxheW91dCB1cGRhdGUuXG4gICAgLy8gTWFjcm8gdGFza3MgKGxpa2UgYHNldFRpbWVvdXRgKSBtaWdodCBiZSBleGVjdXRlZCB3aXRoaW4gdGhlIGN1cnJlbnQgcmVuZGVyaW5nIGZyYW1lIGFuZCBjYXVzZSBhIGZyYW1lIGRyb3AuXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIHRoaXMuaGVpZ2h0LmVtaXQobmF0aXZlRWxlbWVudC5vZmZzZXRIZWlnaHQpO1xuICAgIH0pO1xuXG4gICAgLy8gQ2FyZXRha2VyIG5vdGU6IGBhbmltYXRpb25zdGFydGAgYW5kIGBhbmltYXRpb25lbmRgIGV2ZW50cyBhcmUgZXZlbnQgdGFza3MgdGhhdCB0cmlnZ2VyIGNoYW5nZSBkZXRlY3Rpb24uXG4gICAgLy8gV2UnZCB3YW50IHRvIHRyaWdnZXIgdGhlIGNoYW5nZSBkZXRlY3Rpb24gb25seSBpZiBpdCdzIGFuIGV4aXQgYW5pbWF0aW9uLlxuICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIHRoaXMudW5saXN0ZW5lcnMucHVzaChcbiAgICAgICAgLy8gQ2FyZXRha2VyIG5vdGU6IHdlIGhhdmUgdG8gcmVtb3ZlIHRoZXNlIGV2ZW50IGxpc3RlbmVycyBhdCB0aGUgZW5kIChldmVuIGlmIHRoZSBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSBET00pLlxuICAgICAgICAvLyB6b25lLmpzIHN0b3JlcyBpdHMgYFpvbmVUYXNrYHMgd2l0aGluIHRoZSBgbmF0aXZlRWxlbWVudFtab25lLl9fc3ltYm9sX18oJ2FuaW1hdGlvbnN0YXJ0JykgKyAnZmFsc2UnXWAgcHJvcGVydHlcbiAgICAgICAgLy8gd2l0aCBjYWxsYmFjayB0aGF0IGNhcHR1cmUgYHRoaXNgLlxuICAgICAgICB0aGlzLnJlbmRlcmVyLmxpc3RlbihuYXRpdmVFbGVtZW50LCAnYW5pbWF0aW9uc3RhcnQnLCAoZXZlbnQ6IEFuaW1hdGlvbkV2ZW50KSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMuaXNFeGl0QW5pbWF0aW9uKGV2ZW50KSkge1xuICAgICAgICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHRoaXMuYmVmb3JlQ2xvc2VkLmVtaXQoKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgICAgdGhpcy5yZW5kZXJlci5saXN0ZW4obmF0aXZlRWxlbWVudCwgJ2FuaW1hdGlvbmVuZCcsIChldmVudDogQW5pbWF0aW9uRXZlbnQpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5pc0V4aXRBbmltYXRpb24oZXZlbnQpKSB7XG4gICAgICAgICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4gdGhpcy5hZnRlckNsb3NlZC5lbWl0KHsgZGlzbWlzc2VkQnlBY3Rpb246IHRoaXMuaXNNYW51YWxDbG9zZSwgaWQ6IHRoaXMudG9hc3QuaWQgfSkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnNldFRvYXN0QXR0cmlidXRlcygpO1xuICB9XG5cbiAgc29mdENsb3NlKCkge1xuICAgIGNvbnN0IGV4aXRBbmltYXRpb24gPSBgaG90VG9hc3RFeGl0U29mdEFuaW1hdGlvbiR7XG4gICAgICB0aGlzLnRvcCA/ICdOZWdhdGl2ZScgOiAnUG9zaXRpdmUnXG4gICAgfSAke0VYSVRfQU5JTUFUSU9OX0RVUkFUSU9OfW1zIGZvcndhcmRzIGN1YmljLWJlemllcigwLjA2LCAwLjcxLCAwLjU1LCAxKWA7XG5cbiAgICBjb25zdCBuYXRpdmVFbGVtZW50ID0gdGhpcy50b2FzdEJhckJhc2UubmF0aXZlRWxlbWVudDtcblxuICAgIGFuaW1hdGUobmF0aXZlRWxlbWVudCwgZXhpdEFuaW1hdGlvbik7XG4gICAgdGhpcy5zb2Z0Q2xvc2VkID0gdHJ1ZTtcbiAgfVxuICBzb2Z0T3BlbigpIHtcbiAgICBjb25zdCBzb2Z0RW50ZXJBbmltYXRpb24gPSBgaG90VG9hc3RFbnRlclNvZnRBbmltYXRpb24ke1xuICAgICAgdG9wID8gJ05lZ2F0aXZlJyA6ICdQb3NpdGl2ZSdcbiAgICB9ICR7RU5URVJfQU5JTUFUSU9OX0RVUkFUSU9OfW1zIGN1YmljLWJlemllcigwLjIxLCAxLjAyLCAwLjczLCAxKSBmb3J3YXJkc2A7XG5cbiAgICBjb25zdCBuYXRpdmVFbGVtZW50ID0gdGhpcy50b2FzdEJhckJhc2UubmF0aXZlRWxlbWVudDtcblxuICAgIGFuaW1hdGUobmF0aXZlRWxlbWVudCwgc29mdEVudGVyQW5pbWF0aW9uKTtcbiAgICB0aGlzLnNvZnRDbG9zZWQgPSBmYWxzZTtcbiAgfVxuXG4gIGNsb3NlKCkge1xuICAgIHRoaXMuaXNNYW51YWxDbG9zZSA9IHRydWU7XG5cbiAgICBjb25zdCBleGl0QW5pbWF0aW9uID0gYGhvdFRvYXN0RXhpdEFuaW1hdGlvbiR7XG4gICAgICB0aGlzLnRvcCA/ICdOZWdhdGl2ZScgOiAnUG9zaXRpdmUnXG4gICAgfSAke0VYSVRfQU5JTUFUSU9OX0RVUkFUSU9OfW1zIGZvcndhcmRzIGN1YmljLWJlemllcigwLjA2LCAwLjcxLCAwLjU1LCAxKWA7XG5cbiAgICBjb25zdCBuYXRpdmVFbGVtZW50ID0gdGhpcy50b2FzdEJhckJhc2UubmF0aXZlRWxlbWVudDtcblxuICAgIGFuaW1hdGUobmF0aXZlRWxlbWVudCwgZXhpdEFuaW1hdGlvbik7XG4gIH1cblxuICBoYW5kbGVNb3VzZUVudGVyKCkge1xuICAgIHRoaXMuc2hvd0FsbFRvYXN0cy5lbWl0KHRydWUpO1xuICB9XG4gIGhhbmRsZU1vdXNlTGVhdmUoKSB7XG4gICAgdGhpcy5zaG93QWxsVG9hc3RzLmVtaXQoZmFsc2UpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5jbG9zZSgpO1xuICAgIHdoaWxlICh0aGlzLnVubGlzdGVuZXJzLmxlbmd0aCkge1xuICAgICAgdGhpcy51bmxpc3RlbmVycy5wb3AoKSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaXNFeGl0QW5pbWF0aW9uKGV2OiBBbmltYXRpb25FdmVudCkge1xuICAgIHJldHVybiBldi5hbmltYXRpb25OYW1lLmluY2x1ZGVzKCdob3RUb2FzdEV4aXRBbmltYXRpb24nKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0VG9hc3RBdHRyaWJ1dGVzKCkge1xuICAgIGNvbnN0IHRvYXN0QXR0cmlidXRlczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHRoaXMudG9hc3QuYXR0cmlidXRlcztcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyh0b2FzdEF0dHJpYnV0ZXMpKSB7XG4gICAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZSh0aGlzLnRvYXN0QmFyQmFzZS5uYXRpdmVFbGVtZW50LCBrZXksIHZhbHVlKTtcbiAgICB9XG4gIH1cbn1cbiIsIjxkaXZcbiAgY2xhc3M9XCJob3QtdG9hc3QtYmFyLWJhc2UtY29udGFpbmVyXCJcbiAgW25nU3R5bGVdPVwiY29udGFpbmVyUG9zaXRpb25TdHlsZVwiXG4gIFtuZ0NsYXNzXT1cIidob3QtdG9hc3QtdGhlbWUtJyArIHRvYXN0LnRoZW1lXCJcbiAgW3N0eWxlLi0taG90LXRvYXN0LXNjYWxlXT1cInNjYWxlXCJcbiAgW3N0eWxlLi0taG90LXRvYXN0LXRyYW5zbGF0ZS15XT1cInRyYW5zbGF0ZVlcIlxuPlxuICA8ZGl2XG4gICAgY2xhc3M9XCJob3QtdG9hc3QtYmFyLWJhc2Utd3JhcHBlclwiXG4gICAgKG1vdXNlZW50ZXIpPVwiaGFuZGxlTW91c2VFbnRlcigpXCJcbiAgICAobW91c2VsZWF2ZSk9XCJoYW5kbGVNb3VzZUxlYXZlKClcIlxuICA+XG4gICAgPGRpdlxuICAgICAgY2xhc3M9XCJob3QtdG9hc3QtYmFyLWJhc2VcIlxuICAgICAgI2hvdFRvYXN0QmFyQmFzZVxuICAgICAgW25nU3R5bGVdPVwidG9hc3RCYXJCYXNlU3R5bGVzXCJcbiAgICAgIFtuZ0NsYXNzXT1cInRvYXN0LmNsYXNzTmFtZVwiXG4gICAgICBbc3R5bGUuLS1ob3QtdG9hc3QtYW5pbWF0aW9uLXN0YXRlXT1cImlzTWFudWFsQ2xvc2UgPyAncnVubmluZycgOiAncGF1c2VkJ1wiXG4gICAgICBbc3R5bGUuLS1ob3QtdG9hc3QtZXhpdC1hbmltYXRpb24tc3RhdGVdPVwiaXNTaG93aW5nQWxsVG9hc3RzID8gJ3BhdXNlZCcgOiAncnVubmluZydcIlxuICAgICAgW3N0eWxlLi0taG90LXRvYXN0LWV4aXQtYW5pbWF0aW9uLWRlbGF5XT1cImV4aXRBbmltYXRpb25EZWxheVwiXG4gICAgICBbYXR0ci5hcmlhLWxpdmVdPVwidG9hc3QuYXJpYUxpdmVcIlxuICAgICAgW2F0dHIucm9sZV09XCJ0b2FzdC5yb2xlXCJcbiAgICA+XG4gICAgICA8ZGl2IGNsYXNzPVwiaG90LXRvYXN0LWljb25cIiBhcmlhLWhpZGRlbj1cInRydWVcIj5cbiAgICAgICAgPG5nLWNvbnRhaW5lciAqbmdJZj1cInRvYXN0Lmljb24gIT09IHVuZGVmaW5lZDsgZWxzZSBpbmRpY2F0b3JcIj5cbiAgICAgICAgICA8bmctY29udGFpbmVyICpuZ0lmPVwiaXNJY29uU3RyaW5nOyBlbHNlIGljb25UZW1wbGF0ZU9yQ29tcG9uZW50XCI+XG4gICAgICAgICAgICA8aG90LXRvYXN0LWFuaW1hdGVkLWljb24gW2ljb25UaGVtZV09XCJ0b2FzdC5pY29uVGhlbWVcIj57eyB0b2FzdC5pY29uIH19PC9ob3QtdG9hc3QtYW5pbWF0ZWQtaWNvbj5cbiAgICAgICAgICA8L25nLWNvbnRhaW5lcj5cbiAgICAgICAgICA8bmctdGVtcGxhdGUgI2ljb25UZW1wbGF0ZU9yQ29tcG9uZW50PlxuICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgPG5nLWNvbnRhaW5lciAqZHluYW1pY1ZpZXc9XCJ0b2FzdC5pY29uXCI+PC9uZy1jb250YWluZXI+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8L25nLXRlbXBsYXRlPlxuICAgICAgICA8L25nLWNvbnRhaW5lcj5cblxuICAgICAgICA8bmctdGVtcGxhdGUgI2luZGljYXRvcj5cbiAgICAgICAgICA8aG90LXRvYXN0LWluZGljYXRvciBbdGhlbWVdPVwidG9hc3QuaWNvblRoZW1lXCIgW3R5cGVdPVwidG9hc3QudHlwZVwiPjwvaG90LXRvYXN0LWluZGljYXRvcj5cbiAgICAgICAgPC9uZy10ZW1wbGF0ZT5cbiAgICAgIDwvZGl2PlxuXG4gICAgICA8ZGl2IGNsYXNzPVwiaG90LXRvYXN0LW1lc3NhZ2VcIj5cbiAgICAgICAgPGRpdj5cbiAgICAgICAgICA8bmctY29udGFpbmVyICpkeW5hbWljVmlldz1cInRvYXN0Lm1lc3NhZ2U7IGNvbnRleHQ6IGNvbnRleHQ7IGluamVjdG9yOiB0b2FzdENvbXBvbmVudEluamVjdG9yXCI+PC9uZy1jb250YWluZXI+XG4gICAgICAgIDwvZGl2PlxuICAgICAgPC9kaXY+XG5cbiAgICAgIDxidXR0b25cbiAgICAgICAgKm5nSWY9XCJ0b2FzdC5kaXNtaXNzaWJsZVwiXG4gICAgICAgIChjbGljayk9XCJjbG9zZSgpXCJcbiAgICAgICAgdHlwZT1cImJ1dHRvblwiXG4gICAgICAgIGNsYXNzPVwiaG90LXRvYXN0LWNsb3NlLWJ0blwiXG4gICAgICAgIGFyaWEtbGFiZWw9XCJDbG9zZVwiXG4gICAgICAgIFtuZ1N0eWxlXT1cInRvYXN0LmNsb3NlU3R5bGVcIlxuICAgICAgPjwvYnV0dG9uPlxuICAgIDwvZGl2PlxuICA8L2Rpdj5cbjwvZGl2PlxuIl19